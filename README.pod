=encoding utf8

=head1 NAME

dstar-gantry - convenience wrapper for container-based dstar corpus operations

=cut

##======================================================================
=pod

=head1 SYNOPSIS

 dstar-gantry.sh [GANTRY_OPTS] [GANTRY_ACTION(s)] [-- [DOCKER_OPTS] [-- [BUILD_ARGS]]]

 dstar-gantry.sh Options (GANTRY_OPTS):
   -h, -help             # this help message
   -n, -dry-run          # just print what we would do
   -c CORPUS             # dstar corpus label (required for most operations)
   -d DSTAR_ROOT         # host path for sparse persistent dstar superstructure (default=$HOME/dstar)
   -C CORPUS_ROOT        # host path for dstar corpus checkout (default=DSTAR_ROOT/corpora/CORPUS)
   -S CORPUS_SRC         # host path of dstar corpus sources (default=DSTAR_ROOT/sources/CORPUS/(current/) if present)
   -R RESOURCES_DIR      # host path for persistent CAB resources (default=DSTAR_ROOT/resources/ if present)
   -RO                   # mount RESOURCES_DIR read-only (suppress resource synchronization by container)
   -f RCFILE             # read gantry variables from RCFILE (bash source; default=$HOME/.dstar-gantry.rc)
   -i IMAGE              # use docker image IMAGE (default=lex.dwds.de:443/dstar/dstar-buildhost:latest)
   -e VAR=VALUE          # environment variables are passed to docker-run(1) -e
   -E ENV_FILE           # environment files are passed to docker-run(1) --env-file
   -v /PATH:/MOUNT       # volume options are are passed to docker-run(1) -v
   -x CABX_RUN           # cabx servers for container 'run' action (default=dstar-http-9096)
   -p HTTP_PORT          # map container port 80 to host HTTP_PORT for 'run' action
   -u USER               # build user or UID (default=ddc-admin)
   -g GROUP              # build group or GID (default=ddc-admin)

 dstar-gantry.sh Actions (GANTRY_ACTION(s)):
   init                  # (re-)initialize persistent sparse local DSTAR_ROOT checkout
   sync                  # syncronize local DSTAR_ROOT checkout via `svn update`
   pull                  # retrieve selected IMAGE from docker registry (may require `docker login`)
   gc                    # clean up stale local dstar-buildhost docker images
   ...                   # other actions are passed to container docker/build script (see below)

 Docker Options (DOCKER_OPTS): see docker-run(1).

 Container docker/build Arguments (BUILD_ARGS; see also `dstar-gantry.sh help`):
   help                  # show help for container docker/build script
   self-test             # run rudimentary self-test(s)
   build                 # index a corpus in CORPUS_ROOT/build from sources in CORPUS_SRC/
   update                # update an existing index in CORPUS_ROOT/build/ from CORPUS_SRC/
   update-meta           # update index metadata in in CORPUS_ROOT/build/ from CORPUS_SRC/
   test                  # test a corpus build in CORPUS_ROOT/build/
   archive-build         # archive CORPUS_ROOT/build/ to ${dstar_archive_dir}
   archive-publish       # archive publishable corpus data to ${dstar_archive_dir}
   install               # install CORPUS_ROOT/build/ to CORPUS_ROOT/{server,web}/
   publish               # deploy CORPUS_ROOT/build/ to production host(s)
   run                   # run CORPUS_ROOT/{server,web}/ corpus instance in container
   exec CMD...           # just execute CMD... in container

 Useful container mounts under /dstar:
  config/                # global dstar configuration (read-only)
  resources/             # CAB analysis resources (read-only)
  sources/CORPUS/        # corpus TEI-XML sources (read-only)
  corpora/CORPUS/        # corpus instance checkout (read-write, required)
  corpora/CORPUS/config.local
                         # local corpus configuration overrides

 Host Environment Variables:
   SSH_AUTH_SOCK         # (required) ssh-agent(1) socket

 Container Environment Variables:
  SSH_AUTH_SOCK               # ssh-agent socket (should probably be a bind-mount)
  dstar_init_hooks            # default INIT_HOOK_DIRS (=)

  dstar_build_uid             # user-id in host system (=`id -u`)
  dstar_build_gid             # group-id in host system (=`id -g`)
  dstar_build_umask           # umask for build process (=022)

  dstar_corpora               # corpora to operate on (whitespace-separated list)
  dstar_corpus                # alias for dstar_corpora (=)
  dstar_archive_dir           # target directory for archive-* targets (=)

  dstar_sync_resources        # sync resources (auto|no|force; default=auto)
  dstar_sync_rcfiles          # resources to be synchronized (default:empty -> all)
  dstar_checkout_corpus_opts  # options for dstar-checkout-corpus.sh (=-force -local-config)
  dstar_build_sh_opts         # options for CORPUS/build/build.sh (=-echo-preset=make-info)
  dstar_cabx_run              # cabx expanders to run (=dstar-http-9096)
  dstar_relay_conf            # socat relay configuration (=/etc/default/dstar-relay)

  ...                         # all environment variables are passed down to child processes (e.g. make)

=cut

##======================================================================
=pod

=head1 DESCRIPTION

The C<dstar-gantry> project provides a thin top-level wrapper script
(C<dstar-gantry.sh>) for
D* corpus operations using the latest C<dstar-buildhost> docker image
pulled from the ZDL docker registry at https://lex.dwds.de:443.
The C<dstar-buildhost> docker container invoked
by C<dstar-gantry.sh> can simulate any of the
L<C<BUILDHOST>|$doc/README.html#BUILDHOST>,
L<C<RUNHOST>|$doc/README.html#RUNHOST>,
and/or L<C<WEBHOST>|$doc/README.html#WEBHOST> D* host roles,
but is mostly intended to act as a (virtual) C<BUILDHOST>.

See L</INSTALLATION> for instructions on installing C<dstar-gantry> on
your local machine, see L</USAGE> for details on the various options
and arguments, and see L</EXAMPLES> for some example C<dstar-gantry.sh>
calls.

=cut

##======================================================================
=pod

=head1 INSTALLATION

This section describes the installation procedure for debian-based linux machines.
C<dstar-gantry> was developed and tested on an x86_64 machine running Debian GNU/Linux 10 (buster).
You can probably run gantry on other architectures, but I can't tell you how to do that.

=cut

##--------------------------------------------------------------
=pod

=head2 Requirements

=over 4

=item debian packages

 bash
 openssh-client
 subversion

=item docker

You will need L<docker|https://docs.docker.com/get-docker/> installed on your local machine
with an appropriate L<docker storage driver|/docker storage drivers>,
and the requisite L<permissions|https://docs.docker.com/engine/install/linux-postinstall/>
for your local user account.  C<dstar-gantry> was developed and tested using
the C<docker-ce> and C<docker-ce-client> packages version 19.03.8.

=item registry credentials

If you wish to make use of gantry's C<pull> action to acquire the
lastest C<dstar-buildhost> docker image (recommended), you will
need credentials (username and password) for the ZDL docker registry,
and will need to manually log into the registry
using L<C<docker login>|https://docs.docker.com/engine/reference/commandline/login/>:

 $ docker login https://lex.dwds.de:443
 Username: zdl
 Password: XXXXXXX
 Login Succeeded

=item ssh-agent

You will need an accessible L<ssh-agent|https://en.wikipedia.org/wiki/Ssh-agent>
for your local user account as indicated by the C<SSH_AUTH_SOCK> environment variable,
with at least one registered identity (public+private key-pair).

In order to avoid password prompts during sparse subversion checkouts on the local host
(recommended), your ssh identity should be authorized for password-free access to
C<${USER}@odo.dwds.de>, where I<${USER}> is your username.

In order to avoid password prompts during implicit subversion operations in the
C<dstar-buildhost> container invoked by gantry (recommended), your ssh identity should be
authorized for password-free access to C<ddc@odo.dwds.de>.

If you wish to make use of gantry's
automatic resource synchronization features (default, recommended),
your identity should be authorized for password-free access
to C<${CABRC_RSYNC_USER}@${CABRC_SYNCHOST}> (typically C<ddc@data.dwds.de>).

In order to publish corpus indices via gantry to remote RUNHOSTs and/or WEBHOSTs,
your identity will need to be authorized for password-free access to
C<${PUBLISH_DEST}> and/or C<${WEB_PUBLISH_DEST}> (typically C<ddc-admin@{data,kaskade}.dwds.de>).

See L<C<dstar/doc/README_ssh.txt>|$doc/README_ssh.html> for more details.

=back

=cut

##--------------------------------------------------------------
=pod

=head2 Installation Procedure

=over 4

=item download gantry

Checkout the gantry project itself from SVN to your local machine,
for example to $HOME/dstar-gantry:

 $ svn checkout svn+ssh://odo.dwds.de/home/svn/dev/ddc-dstar/docker/gantry/trunk ~/dstar-gantry

Example output (trimmed):

 A    ~/dstar-gantry/bin
 A    ~/dstar-gantry/bin/dstar-gantry.sh
 ...
 Checked out revision 32806.

=item setup PATH

Put the C<dstar-gantry.sh> script in your C<PATH> (optional, recommended):

 $ export PATH=$PATH:$HOME/dstar-gantry/bin

... or just symlink it into some directory already in your C<PATH>:

 $ sudo ln -s $HOME/dstar-gantry/bin/*.sh /usr/local/bin

=item initialize persistent data

Initialize persistent sparse local dstar checkout in $HOME/dstar:

 $ dstar-gantry.sh init

Example output (trimmed):

 dstar-gantry.sh: INFO: init: (re-)initializing sparse persistent DSTAR_ROOT=/home/USER/dstar
 dstar-gantry.sh: CMD: svn co --depth=files svn+ssh://odo.dwds.de/home/svn/dev/ddc-dstar/trunk /home/USER/dstar
 A    /home/USER/dstar/.DSTAR_ROOT
 ...
 dstar-gantry.sh: INFO: no container actions BUILD_ARG(s) specified: nothing to do.

=item retrieve docker image

Download the latest C<dstar-buildhost> image from the ZDL docker registry:

 $ dstar-gantry.sh pull

Example output (trimmed):

 dstar-gantry.sh: CMD: docker pull lex.dwds.de:443/dstar/dstar-buildhost:latest
 latest: Pulling from dstar/dstar-buildhost
 
 Digest: sha256:e5b47f225619e6b433df0dbcdcdfdfdb93e703893ceb6ed9f78f338e77358a77
 Status: Downloaded newer image for lex.dwds.de:443/dstar/dstar-buildhost:latest
 lex.dwds.de:443/dstar/dstar-buildhost:latest
 dstar-gantry.sh: INFO: no container actions BUILD_ARG(s) specified: nothing to do.

=item run self-test

Run rudimentary self-tests:

 $ dstar-gantry.sh self-test

Example output (trimmed):

 dstar-gantry.sh: INFO: using DSTAR_ROOT=/home/USER/dstar
 dstar-gantry.sh: WARNING: neither CORPUS nor CORPUS_ROOT specified (use the -c or -C options)
 dstar-gantry.sh: WARNING: no CORPUS_SRC directory specified (expect trouble if you're trying to (re-)index a corpus)
 dstar-gantry.sh: INFO: setting RESOURCE_DIR=/local/home/ddc-dstar/dstar/resources
 dstar-gantry.sh: WARNING: CORPUS_ROOT= does not exist (continuing anyway, YMMV)
 dstar-gantry.sh: CMD: docker run --rm -ti --name=dstar-gantry- -v/run/user/1000/ssh-agent.sock:/tmp/ssh-auth-gantry.sock -eSSH_AUTH_SOCK=/tmp/ssh-auth-gantry.sock -v/local/home/ddc-dstar/dstar/resources:/dstar/resources -edstar_build_uid=1008 -edstar_build_gid=1008 -eDSTAR_USER=moocow -edstar_cabx_run=dstar-http-9096 -edstar_corpora= lex.dwds.de:443/dstar/dstar-buildhost:latest /dstar/docker/build self-test
 ...
 build INFO: running self-test(s)
 build INFO: TEST: checking for ssh-agent socket (dstar-nice.sh test -w '/tmp/ssh-agent-wrap.sock')
 build INFO: TEST: checking for ssh-agent identity (test -n "`dstar-nice.sh ssh-add -l | fgrep -v \"no identities\"`")
 build INFO: TEST: svn+ssh access (dstar-nice.sh svn st -u .DSTAR_ROOT)
 Status against revision:  32806
 build INFO: TEST: sync resources (dstar-nice.sh make -C resources sync-test)
 make: Entering directory '/home/ddc-dstar/dstar/resources'
 make: Leaving directory '/home/ddc-dstar/dstar/resources'
 build INFO: TEST: publish to default runhost (ssh "ddc-admin@data.dwds.de" /bin/true)
 build INFO: TEST: publish to default webhost (ssh "ddc-admin@kaskade.dwds.de" /bin/true)
 build INFO: self-test: all tests passed (6/6)

=back

=cut

##======================================================================
=pod

=head1 USAGE

 dstar-gantry.sh [GANTRY_OPTS] [GANTRY_ACTION(s)] [-- [DOCKER_OPTS] [-- [BUILD_ARGS]]]

The C<dstar-gantry.sh> wrapper script is a command-line tool in the UNIX tradition,
and as such accepts a number of options and arguments:

=over 4

=item L<GANTRY_OPTS|/Gantry Options>

C<GANTRY_OPTS> options are interpreted by the C<dstar-gantry.sh> script itself,
including some convenience wrappers for some common
L</Docker Options>.

=item L<GANTRY_ACTION(s)|/Gantry Actions>

C<GANTRY_ACTION(s)> indicate which operation(s) are to be performed,
typically corresponding directly to the L</Container Actions> of the same name.

=item L<DOCKER_OPTS|/Docker Options>

C<DOCKER_OPTS> are passed to
the L<C<docker-run>|https://docs.docker.com/engine/reference/run/>
subprocess.

=item L<BUILD_ARGS|/Container Arguments>

C<BUILD_ARGS> are passed to the
C</dstar/docker/build> script in the invoked C<dstar-buildhost> container.

=back

=cut

##--------------------------------------------------------------
=pod

=head2 Gantry Options

=over 4

=item -h, -help

Display a brief help message.

=item -n, -dry-run

If specified, just prints what would have been done, but doesn't perform any destructive actions.

=item -c CORPUS

Specifies the dstar corpus label ("collection label") for the operand corpus.
Required for most operations.

=item -d DSTAR_ROOT

Specifies the host path used for (sparse) persistent dstar superstructure (default=C<$HOME/dstar>).
By default, persistent CAB resources and index data will be created here.  The directory
will be a sparse checkout of the C<dstar project|https://kaskade.dwds.de/dstar/doc/README.html#Project-Directory-Structure>
containing only partial checkouts of the
L<C<doc/>|https://kaskade.dwds.de/dstar/doc/README.html#doc>,
L<C<corpora/>|https://kaskade.dwds.de/dstar/doc/README.html#corpora>,
L<C<sources/>|https://kaskade.dwds.de/dstar/doc/README.html#sources>,
and L<C<resources/>|https://kaskade.dwds.de/dstar/doc/README.html#resources>
subdirectories.


=item -C CORPUS_ROOT

Specifies the host path used for dstar corpus checkout (default=C<DSTAR_ROOT/corpora/CORPUS>).
Implies L<C<-v CORPUS_ROOT:/dstar/corpora/CORPUS>|/-v /PATH:/MOUNT>.

=item -S CORPUS_SRC

Specifies the host path where dstar corpus sources reside (default=C<DSTAR_ROOT/sources/CORPUS/current/>
if present, otherwise C<DSTAR_ROOT/sources/CORPUS/> if present, otherwise required).
Implies L<C<-v CORPUS_SRC:/dstar/sources/CORPUS:ro>|/-v /PATH:/MOUNT>.

=item -R RESOURCES_DIR

Specifies the host path for persistent CAB resources (default=C<DSTAR_ROOT/resources/> if present).
Implies L<C<-v RESOURCES_DIR:/dstar/resources>|/-v /PATH:/MOUNT>.

=item -RO

If specified and L<RESOURCES_DIR|/-R RESOURCES_DIR> is present on the local machine,
then C<RESOURCES_DIR> will be mounted read-only in the container, which suppresses resource
synchronization by container (saves synchronization overhead and ensures resource consistency).

=item -f RCFILE

Reads gantry configuration variables from C<RCFILE> on the host machine.
C<RCFILE> is evaluated as bash source; default=C<$HOME/.dstar-gantry.rc>.

=item -i IMAGE

Specifies the docker image to be L<pulled|/pull> and/or invoked via
L<C<docker run>|https://docs.docker.com/engine/reference/run/>.
Default is C<lex.dwds.de:443/dstar/dstar-buildhost:latest>.

=item -e VAR=VALUE

Specify an environment variable override for the container
via L<C<docker run -e VAR=VALUE>|https://docs.docker.com/engine/reference/run/#env-environment-variables>.

=item -E ENV_FILE

Specify a file containing environment variable overrides for the container,
via L<C<docker run --env-file ENV_FILE>|https://docs.docker.com/engine/reference/run/#env-environment-variables>.

=item -v /PATH:/MOUNT

Mounts the host directory C</PATH> as a volume into the container at C</MOUNT>,
passed to L<C<docker_run -v>|https://docs.docker.com/engine/reference/run/#volume-shared-filesystems>.

Potentially useful volume mounts C</MOUNT> include:

  /dstar/config/            # global dstar configuration (read-only)
  /dstar/resources/         # CAB analysis resources (read-only)

=item -x CABX_RUN

Select container-internal CAB server(s) to start for container L<run|/run> action;
default=C<dstar-http-9096>.

=item -p HTTP_PORT

Map containers port 80 to host port C<HTTP_PORT> for L<C<run>|/run> action
via L<C<docker run -p HTTP_PORT:80>|https://docs.docker.com/engine/reference/run/#expose-incoming-ports>.

=item -u USER

Specifies username or UID of host build user (default=C<ddc-admin> if present,
otherwise current user).
If the UID does not exist in the container (it probably doesn't), it will be created.

=item -g GROUP

Specifies group name or GID of host build user (default=C<ddc-admin> if present,
otherwise current group).
If the GID does not exist in the container (it probably doesn't), it will be created.

=back

=cut

##--------------------------------------------------------------
=pod

=head2 Gantry Actions

=over 4

=item init

(Re-)initializes persistent sparse local L<C<DSTAR_ROOT>|/-d DSTAR_ROOT> checkout
on the local host (usually C<$HOME/dstar>).
You should only have to call this once per host,
before performing any other C<dstar-gantry.sh> actions.

=item sync

Synchronizes the persistent sparse local L<C<DSTAR_ROOT>|/-d DSTAR_ROOT> checkout
on the local host (usually C<$HOME/dstar>) via `svn update`.  You should typically
call this before each C<dstar-gantry.sh> session, in order to ensure that your
C<DSTAR_ROOT> checkout is up-to-date.

Note that this action does B<NOT> synchronize gantry itself (maybe it will someday),
so to ensure that your C<dstar-gantry.sh> project is up-to-date, you should update
it manually:

 $ svn update ~/dstar-gantry

=item pull

Retrieves the selected L<C<dstar-buildhost> IMAGE|/-i IMAGE> from
the ZDL docker registry.  May require a preceding L<C<docker login>|/registry credentials>.

=item gc

Cleans up stale C<dstar-buildhost> docker images on the local host.

=item L<BUILD_ACTION...|/Container Actions>

Other non-option arguments (not beginning with a dash "-")
are passed verbatim as L</Container Actions> to the
C</dstar/docker/build> script in the suborinate container.

=back

=cut

##--------------------------------------------------------------
=pod

=head2 Docker Options

Docker options following the first C<--> on the C<dstar-gantry.sh> command-line are passed
verbatim to the L<C<docker run>|https://docs.docker.com/engine/reference/run/> subprocess
for the selected L<C<dstar-buildhost> IMAGE|/-i IMAGE>.  If you need to tweak the
C<docker run> call with more than the
C<-e|/-e VAR=VALUE>,
C<-E|/-E ENV_FILE>,
or C<-v|/-v /PATH:/MOUNT>
options, this is how to do it.

=cut

##--------------------------------------------------------------
=pod

=head2 Container Actions

All arguments following the second C<--> on the C<dstar-gantry.sh> command-line are passed
verbatim to the C</dstar/docker/build> script call in the subordinate
L<C<dstar-buildhost>|/-i IMAGE> container.  See the output of
C<dstar-gantry.sh help> for a synopsis of the C</dstar/docker/build> calling
conventions.

=over 4

=item help

Shows a brief help message from the container C</dstar/docker/build> script.

=item self-test

Runs some rudimentary self-test(s) and reports results.
Not all self-tests need to pass in order for C<dstar-gantry.sh> to be useful;
the functionality you need depends on what you're trying to do
and your personal preferences.

=item build

(Re-)indexes a corpus in
L<C<CORPUS_ROOT/build>|/-C CORPUS_ROOT>
from TEI-XML sources in
L<C<CORPUS_SRC/>|/-S CORPUS_SRC>.
This is basically a wrapper for
L<C<dstar-checkout-corpus.sh>|$doc/HOWTO.html#Corpus-Checkout>
and
L<C<CORPUS_ROOT/build/build.sh -build>|/$doc/HOWTO.html#build.sh-and-cron-autobuild.sh>,
i.e.
a C<full corpus re-build|$doc/talks/corpus-ops-2019/#howto-build>.

=item update

Updates an existing corpus index in
L<C<CORPUS_ROOT/build>|/-C CORPUS_ROOT>
from TEI-XML sources in
L<C<CORPUS_SRC/>|/-S CORPUS_SRC>.
This is basically a wrapper for
L<C<dstar-checkout-corpus.sh>|$doc/HOWTO.html#Corpus-Checkout>
and
L<C<CORPUS_ROOT/build/build.sh -update>|/$doc/HOWTO.html#build.sh-and-cron-autobuild.sh>,
i.e.
C<incremental corpus update|https://kaskade.dwds.de/dstar/doc/talks/corpus-ops-2019/#howto-update>

=item update-meta

Updates metadata for an existing corpus index in
L<C<CORPUS_ROOT/build>|/-C CORPUS_ROOT>
from TEI-XML sources in
L<C<CORPUS_SRC/>|/-S CORPUS_SRC>.
This is basically a wrapper for
L<C<dstar-checkout-corpus.sh>|$doc/HOWTO.html#Corpus-Checkout>
and
L<C<CORPUS_ROOT/build/build.sh -update-meta>|/$doc/HOWTO.html#build.sh-and-cron-autobuild.sh>,
i.e.
C<corpus metadata update|$doc/HOWTO_build.html#Consistency-Testing>.

=item test

Runs automated consistency tests for an existing corpus build in
L<C<CORPUS_ROOT/build>|/-C CORPUS_ROOT>.
This is basically a wrapper for
L<C<dstar-checkout-corpus.sh>|$doc/HOWTO.html#Corpus-Checkout>
and
L<C<CORPUS_ROOT/build/build.sh -test>|/$doc/HOWTO.html#build.sh-and-cron-autobuild.sh>,
i.e.
C<corpus consistency tests|$doc/HOWTO.html#Consistency-Tests>.

=item archive-build

Archives an existing
L<C<CORPUS_ROOT/build>|/-C CORPUS_ROOT>
to C<${dstar_archive_dir}>

=item archive-publish

Archives publishable corpus data 
from L<C<CORPUS_ROOT/build>|/-C CORPUS_ROOT>
to C<${dstar_archive_dir}>.

=item install

Installs an existing corpus index from
L<C<CORPUS_ROOT/build>|/-C CORPUS_ROOT>
to
L<C<CORPUS_ROOT/{server,web}>|/-C CORPUS_ROOT>
within the running C<dstar-buildhost> container.

=item publish

Deploy an existing corpus index from
L<C<CORPUS_ROOT/build>|/-C CORPUS_ROOT>
to production host(s) as selected by the
dstar make variables
C<PUBLISH_DEST> and/or C<WEB_PUBLISH_DEST>.

=item run

Runs a L<C<CORPUS>|/-c CORPUS> instance
from
L<C<CORPUS_ROOT/{server,web}>|/-C CORPUS_ROOT>
in the temporary container.
For this action, you will probably also want to specify
L<C<-p HTTP_PORT>|/-p HTTP_PORT>.
If specified, this must be the last container action executed.

=item exec CMD

Just executs C<CMD...> in the subordinate container.
If specified, this must be the final container action executed.
Use with B<extreme caution>.

=back

=cut

##--------------------------------------------------------------
=pod

=head2 Container Environment Variables

The following environment variables influence operations in the
subordinate C<dstar-buildhost> container:

B<CONTINUE HERE>

=over 4

=item SSH_AUTH_SOCK

ssh-agent socket (should probably be a bind-mount)

=item dstar_init_hooks

default INIT_HOOK_DIRS (=)

=item dstar_build_uid

user-id in host system (=`id -u`)

=item dstar_build_gid

group-id in host system (=`id -g`)

=item dstar_build_umask

umask for build process (=022)


=item dstar_corpora

corpora to operate on (whitespace-separated list)

=item dstar_corpus

alias for dstar_corpora (=)

=item dstar_archive_dir

target directory for archive-* targets (=)


=item dstar_sync_resources

sync resources (auto|no|force; default=auto)

=item dstar_sync_rcfiles

resources to be synchronized (default:empty -> all)

=item dstar_checkout_corpus_opts

options for dstar-checkout-corpus.sh (=-force -local-config)

=item dstar_build_sh_opts

options for CORPUS/build/build.sh (=-echo-preset=make-info)

=item dstar_cabx_run

cabx expanders to run (=dstar-http-9096)

=item dstar_relay_conf

socat relay configuration (=/etc/default/dstar-relay)


=item VAR

all environment variables are passed down to child processes (e.g. make)

=back

=cut



##======================================================================
=pod

=head1 CONTINUE HERE

=cut
  
##--------------------------------------------------------------
=pod

=head2 continue here

=cut

##======================================================================
=pod

=head1 EXAMPLES

=cut


##======================================================================
=pod

=head1 CAVEATS

=head2 docker storage drivers

Problems with runtime cross-layer copy operations have been observed using the C<overlay2> docker storage driver,
which is the default in recent version of the C<docker-ce> package.  The C<aufs> docker storage driver does not exhibit
these problemes; see L<https://docs.docker.com/storage/storagedriver/aufs-driver/> for details.
Typically, the C<aufs> driver can be enabled by editing the file F</etc/docker/daemon.json> to contain:


 {
  "storage-driver":"aufs"
 }

... and re-starting any docker services on the host machine.

=cut

##======================================================================
=pod

=head1 SEE ALSO

=over 4

=item *

The L<C<dstar/doc/README.txt>|$doc/README.html> and the references mentioned therein
describe the D* framework in more detail.  Most of the D* documentation
available under L<D* README|$doc/> predates the existence of C<dstar-gantry>
and of the C<dstar-buildhost> image itself, and in the context of
C<dstar-gantry> should be interpreted relative to the running C<dstar-buildhost>
container.

=item *

L<C<dstar/doc/README_sources.txt>|$doc/README_sources.html>
contains details on corpus source TEI-XML conventions.

=item *

L<C<dstar/doc/README_ssh.txt>$doc/README_ssh.html>
may provide some help setting up a new ssh identity.  Note that C<dstar-gantry> requires
an accessible C<ssh-agent>, so if you want to run C<dstar-gantry>
on your local workstation or some other non-production host, you may
need to L<run ssh-agent manually|$doc/README_ssh.html#Manual-ssh-agent-daemon>.

=item *

L<C<dstar/doc/Changes.txt>|$doc/Changes.html>
contains a manual log of D*-related changes.

=item *

See the L<C<docker-run>|https://docs.docker.com/engine/reference/run/> manpage
for details on docker options.

=back

=cut

##======================================================================
=pod

=head1 AUTHOR

Bryan Jurish E<lt>jurish@bbaw.deE<gt> created the ddc-dstar corpus administration system
and the C<dstar-gantry> wrappers.

=cut
